<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Galaxy ã€Œé¦¬ã€ä¸Šæœ‰ç¦®</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Confetti å½©å¸¶ç‰¹æ•ˆ -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- å‹•æ…‹ Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ</text></svg>">
    
    <style>
        @keyframes float {
            0% { transform: translateY(0px) rotate(0deg); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        .particle {
            position: absolute;
            top: -10px;
            color: #FFD700;
            font-size: 1.5rem;
            animation: float 10s linear infinite;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes bounceIn { 
          0% { opacity: 0; transform: scale(0.3); } 
          50% { opacity: 1; transform: scale(1.05); } 
          70% { transform: scale(0.9); }
          100% { transform: scale(1); } 
        }
        @keyframes scratchHand {
            0%, 100% { transform: translate(0, 0) rotate(-10deg); }
            50% { transform: translate(30px, 20px) rotate(10deg); }
        }
        @keyframes pulse-glow {
            0%, 100% { opacity: 1; transform: scale(1); filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5)); }
            50% { opacity: 0.8; transform: scale(1.05); filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.8)); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .animate-bounce-in { animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards; }
        .animate-scratch-hand { animation: scratchHand 1.5s infinite ease-in-out; }
        .animate-pulse-glow { animation: pulse-glow 2s infinite ease-in-out; }
        
        /* éš±è—æ•¸å­—è¼¸å…¥æ¡†çš„ç®­é ­ */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
    </style>
</head>
<body class="bg-red-900 m-0 p-0 overflow-hidden select-none touch-manipulation">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // ==========================================
        //  Google Apps Script URL (å·²æ›´æ–°)
        // ==========================================
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbziifJpiWh5YeffZOMUs58QXr9NWQpG6AjEErtjUHR5o5RjIwEvVgkFXh3Y2-LO_Vfg/exec";

        // --- åœ–ç¤ºçµ„ä»¶ ---
        const Icons = {
            Settings: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            X: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Refresh: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>,
            Save: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Trash: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            Volume2: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>,
            VolumeX: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" x2="17" y1="9" y2="15"/><line x1="17" x2="23" y1="9" y2="15"/></svg>,
            Lock: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Back: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg>
        };

        const STORAGE_KEY = 'samsung_cny_prizes_v2';

        const DEFAULT_PRIZES = [
          { id: 1, name: 'ITFITé›»å‹•ç‰™åˆ·', count: 5, probability: 0, type: 'grand', icon: 'ğŸª¥' },
          { id: 2, name: 'è¼•ç“·ä¿æº«æ¯', count: 10, probability: 0, type: 'major', icon: 'ğŸ¥¤' },
          { id: 3, name: '10,000mAhè¡Œå‹•é›»æº', count: 5, probability: 0, type: 'grand', icon: 'ğŸ”‹' },
          { id: 4, name: 'æ”¾é¬†ç­‹è†œæ§', count: 5, probability: 0, type: 'grand', icon: 'ğŸ”«' },
          { id: 5, name: 'ä¸‰æ˜Ÿç´…åŒ…è¢‹', count: 100, probability: 25, type: 'normal', icon: 'ğŸ§§' },
          { id: 6, name: 'ä¸‰æ˜ŸåŸå­ç­†', count: 200, probability: 70, type: 'normal', icon: 'ğŸ–Šï¸' },
          { id: 7, name: 'ä¸‰æ˜Ÿæ¸…æ½”çµ„', count: 50, probability: 5, type: 'normal', icon: 'ğŸ§¼' },
        ];

        // --- Pin Pad éµç›¤çµ„ä»¶ ---
        const PinPadModal = ({ isOpen, onClose, onSuccess, targetAction }) => {
            const [pin, setPin] = useState("");
            
            useEffect(() => {
                if (isOpen) setPin("");
            }, [isOpen]);

            if (!isOpen) return null;

            const handleNumber = (num) => {
                if (pin.length < 4) setPin(prev => prev + num);
            };

            const handleClear = () => setPin("");
            const handleClose = () => {
                setPin("");
                onClose();
            };

            const handleSubmit = () => {
                const correctPin = targetAction === 'unlock_official' ? '5444' : '6699';
                if (pin === correctPin) {
                    onSuccess();
                    handleClose();
                } else {
                    alert('å¯†ç¢¼éŒ¯èª¤');
                    setPin("");
                }
            };

            return (
                <div className="fixed inset-0 z-[10000] flex items-center justify-center bg-black/80 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 w-80 max-w-full relative">
                        <button onClick={handleClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                            <Icons.X size={24} />
                        </button>
                        <h3 className="text-xl font-bold text-center mb-6 text-gray-800">
                            {targetAction === 'unlock_official' ? 'è§£é™¤é«”é©—æ¨¡å¼' : 'é€²å…¥å¾Œå°ç®¡ç†'}
                        </h3>
                        
                        <div className="flex justify-center gap-4 mb-6">
                            {[0, 1, 2, 3].map(i => (
                                <div key={i} className={`w-4 h-4 rounded-full border-2 ${i < pin.length ? 'bg-red-600 border-red-600' : 'border-gray-300'}`}></div>
                            ))}
                        </div>

                        <div className="grid grid-cols-3 gap-4 mb-6">
                            {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(num => (
                                <button key={num} onClick={() => handleNumber(num)} className="h-14 bg-gray-100 rounded-lg text-2xl font-bold text-gray-700 active:bg-gray-300 transition-colors">
                                    {num}
                                </button>
                            ))}
                            <button onClick={handleClear} className="h-14 bg-red-100 rounded-lg text-red-600 font-bold active:bg-red-200">C</button>
                            <button onClick={() => handleNumber(0)} className="h-14 bg-gray-100 rounded-lg text-2xl font-bold text-gray-700 active:bg-gray-300">0</button>
                            <button onClick={handleSubmit} className="h-14 bg-green-600 rounded-lg text-white font-bold active:bg-green-700">OK</button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('game'); 
            const [mode, setMode] = useState('simulation'); 
            
            // åˆå§‹åŒ–æ™‚è®€å– LocalStorage
            const [prizes, setPrizes] = useState(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                return saved ? JSON.parse(saved) : DEFAULT_PRIZES;
            });

            const [currentResult, setCurrentResult] = useState(null);
            const [showResultModal, setShowResultModal] = useState(false);
            const [resetKey, setResetKey] = useState(0); 
            const [isMuted, setIsMuted] = useState(false);
            
            const [isPinPadOpen, setIsPinPadOpen] = useState(false);
            const [pinPadAction, setPinPadAction] = useState(null); 

            // è³‡æ–™æŒä¹…åŒ–ï¼šç•¶ prizes è®Šå‹•æ™‚å­˜å…¥ LocalStorage
            useEffect(() => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(prizes));
            }, [prizes]);

            // --- Google Sheets Tracking API ---
            const sendToGoogleSheets = async (trackingMode, prize) => {
                if (!GOOGLE_SCRIPT_URL) return;
                
                try {
                    const data = {
                        mode: trackingMode,
                        prizeName: prize.name,
                        prizeId: prize.id
                    };
                    
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    console.log("Data sent to Google Sheets (no-cors mode)");
                } catch (error) {
                    console.error("Failed to send data to Google Sheets:", error);
                }
            };

            // Audio Logic
            const audioCtxRef = useRef(null);
            const scratchGainNodeRef = useRef(null);
            const isScratchingRef = useRef(false);
            
            // å¼·å¥çš„éŸ³æ•ˆåˆå§‹åŒ–åŠŸèƒ½
            const ensureAudioContext = useCallback(() => {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return null;

                // å¦‚æœ Context å­˜åœ¨ä¸”æ²’å£æ‰ï¼Œç›´æ¥å›å‚³
                if (audioCtxRef.current && audioCtxRef.current.state !== 'closed') {
                    if (audioCtxRef.current.state === 'suspended') {
                        audioCtxRef.current.resume().catch(e => console.log("Resume failed", e));
                    }
                    return audioCtxRef.current;
                }

                // å¦å‰‡ï¼Œé‡å»ºæ•´å€‹éŸ³æ•ˆå¼•æ“
                try {
                    const ctx = new AudioContext();
                    audioCtxRef.current = ctx;
                    
                    const bufferSize = 2 * ctx.sampleRate;
                    const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                    const output = noiseBuffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) output[i] = (Math.random() * 2 - 1);

                    const whiteNoiseSource = ctx.createBufferSource();
                    whiteNoiseSource.buffer = noiseBuffer;
                    whiteNoiseSource.loop = true;
                    
                    const gainNode = ctx.createGain();
                    gainNode.gain.value = 0;
                    
                    const filter = ctx.createBiquadFilter();
                    filter.type = 'lowpass';
                    filter.frequency.value = 600; 
                    
                    whiteNoiseSource.connect(filter);
                    filter.connect(gainNode);
                    gainNode.connect(ctx.destination);
                    
                    whiteNoiseSource.start();
                    scratchGainNodeRef.current = gainNode;
                    return ctx;
                } catch (e) {
                    console.error("Audio init error", e);
                    return null;
                }
            }, []);

            const playWinSound = useCallback(() => {
                if (isMuted) return;
                const ctx = ensureAudioContext(); // ç¢ºä¿ Context æ´»è‘—
                if (!ctx) return;

                const playTone = (freq, start, dur) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(0.1, start);
                    gain.gain.exponentialRampToValueAtTime(0.01, start + dur);
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.start(start);
                    osc.stop(start + dur);
                };
                const now = ctx.currentTime;
                playTone(523.25, now, 0.2); playTone(659.25, now+0.1, 0.2); 
                playTone(783.99, now+0.2, 0.2); playTone(1046.50, now+0.3, 0.6);
            }, [isMuted, ensureAudioContext]);

            const toggleScratchSound = useCallback((playing) => {
                if (isMuted) return;
                // å¦‚æœè¦æ’­æ”¾ï¼Œå…ˆç¢ºä¿å¼•æ“æ´»è‘—
                if (playing) ensureAudioContext();
                
                if (!scratchGainNodeRef.current || !audioCtxRef.current) return;

                const gain = scratchGainNodeRef.current.gain;
                const now = audioCtxRef.current.currentTime;
                
                if (playing && !isScratchingRef.current) {
                    gain.cancelScheduledValues(now);
                    gain.linearRampToValueAtTime(0.2, now + 0.1);
                    isScratchingRef.current = true;
                } else if (!playing && isScratchingRef.current) {
                    gain.cancelScheduledValues(now);
                    gain.linearRampToValueAtTime(0, now + 0.1);
                    isScratchingRef.current = false;
                }
            }, [isMuted, ensureAudioContext]);

            const calculatePrize = (currentPrizes) => {
                let pool = [];

                if (mode === 'simulation') {
                    // æ¨¡æ“¬æ¨¡å¼ï¼šç‰¹å®šå¤§çæ©Ÿç‡å„ 5%ï¼Œå…¶é¤˜å¹³åˆ†å‰©é¤˜æ©Ÿç‡
                    const targetIds = [1, 2, 3, 4]; 
                    const targetProb = 5; // 5%
                    
                    const otherPrizes = currentPrizes.filter(p => !targetIds.includes(p.id));
                    const totalTargetProb = targetIds.length * targetProb; // 20%
                    const remainingProb = 100 - totalTargetProb; // 80%
                    const otherProb = otherPrizes.length > 0 ? remainingProb / otherPrizes.length : 0;

                    pool = currentPrizes.map(p => {
                        if (targetIds.includes(p.id)) {
                            return { ...p, probability: targetProb };
                        } else {
                            return { ...p, probability: otherProb };
                        }
                    });
                } else {
                    // æ­£å¼æ¨¡å¼ï¼šä¾æ“šå¾Œå°è¨­å®šçš„æ©Ÿç‡èˆ‡åº«å­˜
                    pool = currentPrizes.filter(p => p.count > 0 && p.probability > 0);
                }

                if (pool.length === 0) return { id: -1, name: 'ä¸‹æ¬¡å¥½é‹ï¼', icon: 'ğŸ', type: 'none' };

                const totalWeight = pool.reduce((sum, p) => sum + parseFloat(p.probability), 0);
                let random = Math.random() * totalWeight;

                for (const prize of pool) {
                    if (random < prize.probability) return prize;
                    random -= prize.probability;
                }
                return pool[pool.length - 1];
            };

            const startNewGame = useCallback(() => {
                setCurrentResult(calculatePrize(prizes));
                setResetKey(prev => prev + 1);
                setShowResultModal(false);
                toggleScratchSound(false);
            }, [prizes, toggleScratchSound, mode]);

            useEffect(() => {
                startNewGame();
            }, [mode]);

            // çµ„ä»¶å¸è¼‰æ™‚å˜—è©¦é—œé–‰ Context (é¿å…è¨˜æ†¶é«”æ´©æ¼ï¼Œä½†åœ¨ SPA ä¸­é€šå¸¸ä¸è§¸ç™¼)
            useEffect(() => {
                return () => { 
                    if(audioCtxRef.current && audioCtxRef.current.state !== 'closed') {
                        audioCtxRef.current.close().catch(() => {}); 
                    }
                };
            }, []);

            const handleScratchComplete = () => {
                toggleScratchSound(false);
                
                if (mode === 'official' && currentResult && currentResult.id > 0) {
                    setPrizes(prev => prev.map(p => p.id === currentResult.id ? { ...p, count: p.count - 1 } : p));
                }

                confetti({
                    particleCount: 150,
                    spread: 70,
                    origin: { y: 0.6 }
                });
                
                sendToGoogleSheets(mode, currentResult);

                setTimeout(() => { setShowResultModal(true); playWinSound(); }, 500);
            };

            const handleModalClose = () => {
                if (mode === 'official') {
                    setMode('simulation');
                } else {
                    startNewGame();
                }
            };

            // Idle Timer
            useEffect(() => {
                let timeoutId;
                const resetTimer = () => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => {
                        if (mode === 'official') {
                            setMode('simulation');
                        } else {
                            startNewGame();
                        }
                    }, 180000); // 3åˆ†é˜
                };
                const events = ['mousemove', 'mousedown', 'touchstart', 'click', 'keydown'];
                const handler = () => { 
                    resetTimer(); 
                    // é€™è£¡ä¸éœ€æ¯æ¬¡éƒ½ unlockAudioï¼Œé¿å…é »ç¹ resume é€ æˆå•é¡Œï¼Œæ”¹åœ¨ touchstart è™•ç†
                };
                events.forEach(e => window.addEventListener(e, handler));
                resetTimer();
                return () => {
                    clearTimeout(timeoutId);
                    events.forEach(e => window.removeEventListener(e, handler));
                };
            }, [startNewGame, mode]);

            // Handlers for PinPad
            const openUnlockModal = () => {
                setPinPadAction('unlock_official');
                setIsPinPadOpen(true);
            };
            const openAdminModal = () => {
                setPinPadAction('admin_access');
                setIsPinPadOpen(true);
            };
            const handlePinSuccess = () => {
                if (pinPadAction === 'unlock_official') {
                    setMode('official');
                    alert("å·²è§£é–ï¼é€²å…¥æ­£å¼æŠ½çæ¨¡å¼ã€‚");
                } else if (pinPadAction === 'admin_access') {
                    setView('admin');
                }
            };

            // é‡ç½®è³‡æ–™ (æ¢å¾©é è¨­)
            const handleResetData = () => {
                if(confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰æ•¸æ“šå—ï¼Ÿé€™å°‡æ¢å¾©é è¨­åº«å­˜èˆ‡æ©Ÿç‡ã€‚')) {
                    setPrizes(DEFAULT_PRIZES);
                    localStorage.removeItem(STORAGE_KEY);
                }
            };

            return (
                <div className="min-h-screen bg-red-900 font-sans overflow-hidden relative selection:bg-yellow-500 selection:text-red-900">
                    {/* Background */}
                    <div className="absolute inset-0 overflow-hidden pointer-events-none">
                        <div className="absolute -top-20 -left-20 w-64 h-64 bg-yellow-500 rounded-full blur-[100px] opacity-20 animate-pulse"></div>
                        <div className="absolute top-1/2 -right-20 w-80 h-80 bg-red-500 rounded-full blur-[120px] opacity-30"></div>
                        <div className="absolute bottom-0 left-1/3 w-full h-32 bg-gradient-to-t from-red-950 to-transparent opacity-80"></div>
                        {[...Array(10)].map((_, i) => (
                            <div key={i} className="particle" style={{left: `${Math.random()*100}%`, animationDelay: `${Math.random()*5}s`, fontSize: `${Math.random()*20+10}px`}}>âœ¨</div>
                        ))}
                    </div>

                    {/* Toolbar - ALWAYS VISIBLE FIXED BOTTOM RIGHT */}
                    <div className="fixed bottom-6 right-6 z-[9999] flex gap-4 pointer-events-auto">
                        <button 
                            onClick={() => setIsMuted(!isMuted)}
                            className="w-14 h-14 bg-black/40 backdrop-blur-md rounded-full flex items-center justify-center text-white/80 hover:bg-black/60 shadow-lg active:scale-95 transition-all"
                        >
                            {isMuted ? <Icons.VolumeX size={28} /> : <Icons.Volume2 size={28} />}
                        </button>
                        
                        {view === 'game' && mode === 'simulation' && (
                            <button 
                                onClick={openUnlockModal}
                                className="w-14 h-14 bg-black/40 backdrop-blur-md rounded-full flex items-center justify-center text-white/50 hover:text-white hover:bg-black/60 shadow-lg active:scale-95 transition-all"
                            >
                                <Icons.Lock size={28} />
                            </button>
                        )}
                    </div>

                    <PinPadModal 
                        isOpen={isPinPadOpen} 
                        onClose={() => setIsPinPadOpen(false)} 
                        onSuccess={handlePinSuccess}
                        targetAction={pinPadAction}
                    />

                    {view === 'game' ? (
                        <GameInterface 
                            result={currentResult} 
                            onComplete={handleScratchComplete} 
                            resetKey={resetKey}
                            onScratchStart={() => toggleScratchSound(true)}
                            onScratchEnd={() => toggleScratchSound(false)}
                            mode={mode}
                            onAdminClick={openAdminModal}
                        />
                    ) : (
                        <AdminPanel 
                            prizes={prizes} 
                            setPrizes={setPrizes} 
                            onClose={() => setView('game')} 
                            onResetData={handleResetData}
                        />
                    )}

                    {showResultModal && (
                        <ResultModal 
                            result={currentResult} 
                            onClose={handleModalClose}
                            mode={mode} 
                        />
                    )}
                </div>
            );
        };

        const GameInterface = ({ result, onComplete, resetKey, onScratchStart, onScratchEnd, mode, onAdminClick }) => {
            const isSimulation = mode === 'simulation';
            // State to track if user started scratching to hide hand
            const [hasStartedScratching, setHasStartedScratching] = useState(false);

            // Reset when resetKey changes (new game)
            useEffect(() => {
                setHasStartedScratching(false);
            }, [resetKey]);

            const handleScratchStart = () => {
                if (!hasStartedScratching) setHasStartedScratching(true);
                onScratchStart();
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen w-full px-4 py-8 z-10 relative gap-6">
                    {/* Admin Button (Top Right) */}
                    {!isSimulation && (
                        <div className="absolute top-6 right-6 z-50">
                           <button onClick={onAdminClick} className="w-12 h-12 bg-black/30 backdrop-blur rounded-full flex items-center justify-center text-white/60 hover:text-white hover:bg-black/50 transition-all">
                                <Icons.Settings size={24} />
                           </button>
                        </div>
                    )}

                    <header className="w-full text-center z-20 space-y-2">
                        <h2 className="text-yellow-400 font-bold tracking-widest text-2xl md:text-3xl uppercase drop-shadow-md">
                            ä¸‰æ˜Ÿæ——è‰¦é«”é©—é¤¨-å¾®é¢¨å—å±±
                        </h2>
                        <h1 className="text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-100 to-yellow-500 drop-shadow-lg filter pb-2">
                            Galaxy ã€Œé¦¬ã€ä¸Šæœ‰ç¦®
                        </h1>
                        {!isSimulation && (
                            <div className="flex justify-center">
                                <span className="bg-red-600/90 text-white text-sm px-4 py-1 rounded-full shadow-lg border border-red-400 font-bold animate-pulse">
                                    ğŸ”¥ æ­£å¼æŠ½çæ¨¡å¼ ğŸ”¥
                                </span>
                            </div>
                        )}
                    </header>

                    {/* Scratch Card Area */}
                    <div className="relative group shrink-0 mt-4">
                        <div className="absolute -inset-2 bg-gradient-to-r from-yellow-600 via-yellow-200 to-yellow-600 rounded-2xl blur opacity-75 group-hover:opacity-100 animate-tilt duration-1000"></div>
                        <div className="relative w-[320px] h-[320px] md:w-[520px] md:h-[420px] bg-white rounded-xl shadow-2xl overflow-hidden border-4 border-yellow-600 cursor-pointer">
                            {/* Reward (Underneath) */}
                            <div className="absolute inset-0 flex flex-col items-center justify-center bg-red-50 pattern-grid-lg text-center p-6">
                                <div className="animate-bounce mb-4 text-6xl md:text-8xl filter drop-shadow-lg">
                                    {result?.icon || 'ğŸ'}
                                </div>
                                <h3 className="text-xl md:text-3xl font-bold text-red-800 mb-2">
                                    {isSimulation ? 'é«”é©—çµæœ' : 'æ­å–œç²å¾—'}
                                </h3>
                                <p className="text-2xl md:text-4xl font-black text-red-600 leading-tight px-4">
                                    {result?.name || 'ç¥ç§˜å¥½ç¦®'}
                                </p>
                            </div>
                            
                            {/* Canvas (Cover) */}
                            <ScratchCanvas 
                                width={520} 
                                height={420} 
                                onComplete={onComplete}
                                resetKey={resetKey}
                                onScratchStart={handleScratchStart}
                                onScratchEnd={onScratchEnd}
                            />

                            {/* Finger Hint Animation (Overlay) - Hide when scratching starts */}
                            {!hasStartedScratching && (
                                <div className="absolute inset-0 pointer-events-none flex items-center justify-center z-20">
                                    <div className="animate-scratch-hand opacity-80 text-7xl drop-shadow-2xl">
                                        ğŸ‘†
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="mt-4 px-8 py-3 bg-black/40 backdrop-blur rounded-full border border-yellow-500/50 shadow-lg animate-pulse-glow">
                        <p className="text-yellow-200 font-bold text-xl tracking-wide">
                            âœ¨ è©¦è©¦æ‰‹æ°£ï¼åˆ®é–‹éŠ€æ¼†æ‹¿å¥½ç¦® âœ¨
                        </p>
                    </div>
                </div>
            );
        };

        const ScratchCanvas = ({ width, height, onComplete, resetKey, onScratchStart, onScratchEnd }) => {
            const canvasRef = useRef(null);
            const [completed, setCompleted] = useState(false);
            const [isDrawing, setIsDrawing] = useState(false);

            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                canvas.style.transition = 'none';
                canvas.style.opacity = '1';
                setCompleted(false);
                canvas.width = width;
                canvas.height = height;

                ctx.globalCompositeOperation = 'source-over';
                ctx.fillStyle = '#CCCCCC';
                ctx.fillRect(0, 0, width, height);
                
                // Noise
                for(let i=0; i<4000; i++) {
                    ctx.fillStyle = Math.random() > 0.5 ? '#AAAAAA' : '#DDDDDD';
                    ctx.fillRect(Math.random() * width, Math.random() * height, 2, 2);
                }

                // Text
                ctx.font = 'bold 36px sans-serif';
                ctx.fillStyle = '#666666';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = 'bold 32px sans-serif';
                ctx.fillText('åˆ®é–‹ç«‹å³ä¸­ç', width / 2, height / 2);

                // Border
                ctx.strokeStyle = '#B8860B';
                ctx.lineWidth = 12;
                ctx.strokeRect(0, 0, width, height);
            }, [resetKey, width, height]);

            const checkProgress = () => {
                if (completed) return;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const imageData = ctx.getImageData(0, 0, width, height);
                const pixels = imageData.data;
                let transparent = 0;
                for (let i = 0; i < pixels.length; i += 40) {
                    if (pixels[i + 3] < 128) transparent++;
                }
                if ((transparent / (pixels.length / 40)) * 100 > 45) {
                    setCompleted(true);
                    canvas.style.transition = 'opacity 0.8s';
                    canvas.style.opacity = '0';
                    onComplete();
                }
            };

            const draw = (e) => {
                if (!isDrawing || completed) return;
                e.preventDefault(); 
                const canvas = canvasRef.current;
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                const x = (clientX - rect.left) * (width / rect.width);
                const y = (clientY - rect.top) * (height / rect.height);

                const ctx = canvas.getContext('2d');
                ctx.globalCompositeOperation = 'destination-out';
                ctx.beginPath();
                ctx.arc(x, y, 35, 0, Math.PI * 2);
                ctx.fill();

                if (Math.random() > 0.7) checkProgress();
            };

            const start = () => { if (!completed) { setIsDrawing(true); onScratchStart(); } };
            const end = () => { setIsDrawing(false); onScratchEnd(); };

            return (
                <canvas
                    ref={canvasRef}
                    className="absolute inset-0 w-full h-full cursor-pointer touch-none z-10"
                    onMouseDown={start} onMouseUp={end} onMouseLeave={end} onMouseMove={draw}
                    onTouchStart={start} onTouchEnd={end} onTouchMove={draw}
                />
            );
        };

        const ResultModal = ({ result, onClose, mode }) => {
            const isSimulation = mode === 'simulation';
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-md animate-fade-in">
                    <div className="bg-white rounded-3xl w-full max-w-md overflow-hidden shadow-2xl transform transition-all animate-bounce-in">
                        {/* Header */}
                        <div className="bg-red-600 p-6 text-center relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/diagmonds-light.png')] opacity-20"></div>
                            <h2 className="text-3xl font-extrabold text-yellow-300 relative z-10 drop-shadow-md">
                                {isSimulation ? 'æ­å–œå®Œæˆæ¨¡æ“¬æŠ½ç!' : 'ğŸ‰ æ­å–œä¸­ç ğŸ‰'}
                            </h2>
                        </div>

                        {/* Content */}
                        <div className="p-8 bg-gradient-to-b from-white to-red-50">
                            {/* Simulation Mode Content */}
                            {isSimulation ? (
                                <>
                                    {/* Simulation Prize - Smaller */}
                                    <div className="flex items-center justify-center gap-4 mb-6 bg-white p-4 rounded-xl shadow-sm border border-red-100">
                                        <div className="text-5xl filter drop-shadow-md shrink-0">{result?.icon}</div>
                                        <h3 className="text-2xl font-black text-gray-800 text-left leading-tight">{result?.name}</h3>
                                    </div>

                                    {/* Instructions for Simulation */}
                                    <div className="mb-8 p-5 bg-yellow-50 border-2 border-dashed border-yellow-500 rounded-xl">
                                        <div className="text-left text-base text-gray-800 space-y-3 font-bold">
                                            <p className="flex gap-3"><span className="text-red-600 text-xl">1.</span> <span>æ‰¾åˆ°æˆ‘å€‘ç†±æƒ…çš„é–€å¸‚å¤¥ä¼´ï¼</span></p>
                                            <p className="flex gap-3"><span className="text-red-600 text-xl">2.</span> <span>æƒæQR Codeï¼ŒåŠ å…¥å®˜æ–¹LINE@ã€‚</span></p>
                                            <p className="flex gap-3"><span className="text-red-600 text-xl">3.</span> <span>å³å¯åƒåŠ ã€Œæ­£å¼æŠ½çã€ï¼</span></p>
                                        </div>
                                        <div className="w-48 h-48 bg-white mx-auto mt-4 p-2 shadow-sm rounded-lg flex items-center justify-center">
                                           <img src="https://github.com/andyhhsu/Breeze-Scratch/blob/main/qr.ioi.tw%20(26).png?raw=true" className="w-full h-full object-contain" alt="QR Code" />
                                        </div>
                                    </div>
                                </>
                            ) : (
                                /* Official Mode Content - NO QR, Larger Prize */
                                <div className="flex flex-col items-center justify-center py-4">
                                    <div className="w-40 h-40 bg-yellow-100 rounded-full flex items-center justify-center mb-6 animate-pulse-glow shadow-inner border-4 border-yellow-300">
                                        <div className="text-8xl filter drop-shadow-lg transform hover:scale-110 transition-transform">{result?.icon}</div>
                                    </div>
                                    <h3 className="text-4xl font-black text-red-600 text-center leading-tight mb-3 drop-shadow-sm">
                                        {result?.name}
                                    </h3>
                                    <p className="text-gray-500 text-base mb-8 font-medium bg-white/80 px-4 py-1 rounded-full shadow-sm">
                                        è«‹å‘é–€å¸‚äººå“¡å‡ºç¤ºæ­¤ç•«é¢é ˜ç
                                    </p>
                                </div>
                            )}

                            <button onClick={onClose} className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-full shadow-lg text-lg flex items-center justify-center gap-2 active:scale-95 transition-transform">
                                <Icons.Refresh size={24} /> é—œé–‰è¦–çª—
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const AdminPanel = ({ prizes, setPrizes, onClose, onResetData }) => {
            const handleChange = (id, field, value) => {
                setPrizes(prizes.map(p => p.id === id ? { ...p, [field]: value } : p));
            };
            return (
                <div className="absolute inset-0 bg-gray-50 z-50 flex flex-col overflow-hidden">
                    <div className="bg-white shadow-sm p-4 flex justify-between items-center z-10">
                        <h2 className="text-xl font-bold flex items-center gap-2 text-gray-800">
                            <Icons.Settings className="text-red-600" /> å¾Œå°çå“è¨­å®š
                        </h2>
                        <div className="flex gap-2">
                            <button onClick={onResetData} className="p-2 bg-red-100 text-red-600 rounded-full hover:bg-red-200" title="é‡ç½®æ•¸æ“š"><Icons.Trash size={20}/></button>
                            <button onClick={onClose} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200"><Icons.X /></button>
                        </div>
                    </div>
                    <div className="flex-1 overflow-auto p-4 md:p-8">
                        <div className="max-w-4xl mx-auto bg-white rounded-xl shadow p-6">
                            <table className="w-full text-left">
                                <thead className="bg-gray-50 text-gray-600 text-sm border-b">
                                    <tr><th className="p-3">åœ–ç¤º</th><th className="p-3">çå“åç¨±</th><th className="p-3">å‰©é¤˜æ•¸é‡</th><th className="p-3">æ¬Šé‡ (%)</th><th className="p-3">æ¨™ç±¤</th></tr>
                                </thead>
                                <tbody className="divide-y">
                                    {prizes.map((p) => (
                                        <tr key={p.id} className="hover:bg-gray-50">
                                            <td className="p-3 text-2xl">{p.icon}</td>
                                            <td className="p-3"><input type="text" value={p.name} onChange={(e)=>handleChange(p.id,'name',e.target.value)} className="border rounded px-2 py-1 w-full"/></td>
                                            <td className="p-3"><input type="number" min="0" value={String(p.count)} onChange={(e)=>handleChange(p.id,'count',parseInt(e.target.value)||0)} className="border rounded px-2 py-1 w-24"/></td>
                                            <td className="p-3 flex items-center gap-2">
                                                <input type="number" min="0" step="0.001" value={String(p.probability)} onChange={(e)=>handleChange(p.id,'probability',parseFloat(e.target.value)||0)} className="border rounded w-24 text-center"/>
                                            </td>
                                            <td className="p-3"><span className="text-xs bg-gray-200 px-2 py-1 rounded">{p.type}</span></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            <div className="mt-6 flex justify-end">
                                <button onClick={onClose} className="bg-green-600 text-white px-6 py-2 rounded-lg flex items-center gap-2 shadow hover:bg-green-700"><Icons.Save size={20}/> ä¿å­˜è¨­å®š</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
